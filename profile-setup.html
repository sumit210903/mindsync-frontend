<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindSync - Profile Setup</title>

  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
    body { background: linear-gradient(135deg, #dff6f0, #b9e5e8, #a7c7e7); color: #2c3e50; min-height: 100vh; }

    nav {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 8%;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex-wrap: wrap;
    }
    nav h1 { font-size: 26px; font-weight: 700; color: #006c59; display: flex; align-items: center; gap: 8px; }
    nav h1 i { font-size: 28px; color: #006c59; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
    nav ul { list-style: none; display: flex; gap: 25px; flex-wrap: wrap; }
    nav ul li a {
      text-decoration: none; color: #2c3e50; font-size: 16px; font-weight: 600;
      display: flex; align-items: center; gap: 6px; transition: color 0.3s, transform 0.3s;
    }
    nav ul li a:hover { color: #006c59; transform: scale(1.1); }
    .menu-toggle { display: none; font-size: 24px; cursor: pointer; color: #006c59; }
    @media (max-width: 768px) {
      nav ul { display: none; flex-direction: column; width: 100%; margin-top: 15px; gap: 15px; }
      nav ul.show { display: flex; }
      .menu-toggle { display: block; }
    }

    .hero {
      min-height: 25vh; display: flex; justify-content: center; align-items: center;
      text-align: center; padding: 30px 20px;
      background: linear-gradient(120deg, rgba(0,108,89,0.8), rgba(167,199,231,0.7));
      color: #fff;
    }
    .hero h2 { font-size: 32px; font-weight: 700; }

    .setup-section { display: flex; justify-content: center; align-items: center; padding: 60px 8%; }
    .setup-card {
      background: #fff; padding: 40px 30px; border-radius: 20px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      max-width: 500px; width: 100%; text-align: center;
    }
    .setup-card h3 { color: #006c59; margin-bottom: 25px; }
    .setup-card input, .setup-card select, .setup-card textarea {
      width: 100%; padding: 12px 15px; margin-bottom: 15px;
      border-radius: 10px; border: 1px solid #ccc; font-size: 14px;
    }
    .setup-card textarea { resize: none; height: 80px; }
    .setup-card button {
      background: #006c59; color: #fff; padding: 12px 25px;
      border: none; border-radius: 25px; font-size: 14px;
      font-weight: 600; cursor: pointer;
      transition: background 0.3s, transform 0.3s; width: 100%;
    }
    .setup-card button:hover { background: #74ebd5; transform: scale(1.05); }
    .loading { margin-top: 10px; font-size: 14px; color: #006c59; display: none; }

    .preview {
      width: 100px; height: 100px;
      border-radius: 50%; object-fit: cover;
      margin-bottom: 15px; display: none;
    }

    footer { background: #006c59; color: #fff; text-align: center; padding: 22px; margin-top: 50px; font-size: 14px; }
  </style>

</head>

<body>

  <nav>
    <h1><i class="fa-solid fa-brain"></i> MindSync</h1>
    <div class="menu-toggle"><i class="fa-solid fa-bars"></i></div>
    <ul>
      <li><a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a></li>
      <li><a href="wellness.html"><i class="fa-solid fa-chart-line"></i> Wellness</a></li>
      <li><a href="fitness.html"><i class="fa-solid fa-dumbbell"></i> Fitness</a></li>
      <li><a href="nutrition.html"><i class="fa-solid fa-utensils"></i> Nutrition</a></li>
      <li><a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a></li>
    </ul>
  </nav>

  <section class="hero">
    <h2>Set Up Your Profile</h2>
  </section>

  <section class="setup-section">
    <div class="setup-card">
      <h3>Complete Your Profile</h3>
      <img id="previewImg" class="preview" alt="Profile Preview">
      <form id="profileForm">
        <input type="number" id="age" placeholder="Age" required>
        <select id="gender" required>
          <option value="" disabled selected>Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <input type="text" id="goal" placeholder="Your Wellness Goal (e.g., Stress Relief, Fitness)" required>
        <textarea id="bio" placeholder="Short Bio (optional)"></textarea>
        <input type="file" id="profilePic" accept="image/*">
        <button type="submit">Save & Continue to Dashboard</button>
        <p class="loading" id="loadingMsg">Saving profile...</p>
      </form>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 MindSync. Empowering wellness through synergy üíôüåø</p>
  </footer>

<script>
  // üåê Responsive menu
  document.querySelector('.menu-toggle').addEventListener('click', () => {
    document.querySelector('nav ul').classList.toggle('show');
  });

  const form = document.getElementById("profileForm");
  const loadingMsg = document.getElementById("loadingMsg");
  const previewImg = document.getElementById("previewImg");
  const profilePicInput = document.getElementById("profilePic");

  // üß† Allow access ONLY right after signup
  (async function checkAccess() {
    const token = localStorage.getItem("token");
    const needsSetup = localStorage.getItem("needsSetup"); // Flag set during signup

    // If no token or no setup flag, redirect to dashboard/login
    if (!token) {
      alert("‚ö†Ô∏è Please log in to continue.");
      window.location.href = "login.html";
      return;
    }

    if (!needsSetup) {
      console.log("‚úÖ User already has a profile, redirecting to dashboard...");
      window.location.href = "dashboard.html";
      return;
    }

    // Optional: Verify token
    try {
      const verifyRes = await fetch("https://mindsync-backend-c7v9.onrender.com/api/users/profile", {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!verifyRes.ok) {
        localStorage.removeItem("token");
        localStorage.removeItem("needsSetup");
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
      }
    } catch (err) {
      console.error("Token verification failed:", err);
      localStorage.removeItem("token");
      localStorage.removeItem("needsSetup");
      window.location.href = "login.html";
    }
  })();

  // üñºÔ∏è Profile picture preview
  profilePicInput.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else {
      previewImg.style.display = "none";
    }
  });

  // üíæ Handle form submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    loadingMsg.style.display = "block";

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Session expired. Please log in again.");
      window.location.href = "login.html";
      return;
    }

    const formData = new FormData();
    formData.append("age", document.getElementById("age").value.trim());
    formData.append("gender", document.getElementById("gender").value);
    formData.append("goal", document.getElementById("goal").value.trim());
    formData.append("bio", document.getElementById("bio").value.trim());

    const profilePic = profilePicInput.files[0];
    if (profilePic) formData.append("profilePic", profilePic);

    try {
      const response = await fetch("https://mindsync-backend-c7v9.onrender.com/api/users/profile-setup", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });

      const data = await response.json();
      loadingMsg.style.display = "none";

      if (response.ok) {
        alert("‚úÖ Profile setup complete! Redirecting to dashboard...");
        localStorage.removeItem("needsSetup"); // Clear flag after setup
        localStorage.setItem("userProfile", JSON.stringify(data.data || {}));
        window.location.href = "dashboard.html";
      } else if (response.status === 401) {
        localStorage.removeItem("token");
        localStorage.removeItem("needsSetup");
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
      } else {
        console.warn("‚ùå Setup error:", data);
        alert(data.message || "Profile setup failed. Please try again.");
      }
    } catch (error) {
      console.error("‚ö†Ô∏è Network/server error:", error);
      loadingMsg.style.display = "none";
      alert("Server error. Please try again later.");
    }
  });
</script>


</body>
</html>
